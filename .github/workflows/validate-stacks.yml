name: Validate Stacks

on:
  pull_request:
    paths:
      - 'stacks/**'
      - '.github/workflows/validate-stacks.yml'
  push:
    branches:
      - main
    paths:
      - 'stacks/**'

jobs:
  validate-compose:
    name: Validate Docker Compose Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Compose
        run: |
          docker compose version
      
      - name: Validate all compose files
        run: |
          for compose_file in $(find stacks -name 'docker-compose.yml' -type f); do
            dir=$(dirname $compose_file)
            echo "Validating $compose_file"
            
            # Check if .env.example exists
            if [ ! -f "$dir/.env.example" ]; then
              echo "::error::Missing .env.example in $dir"
              exit 1
            fi
            
            # Copy .env.example to .env for validation
            cp "$dir/.env.example" "$dir/.env" 2>/dev/null || true
            
            # Validate compose file
            cd "$dir"
            docker compose config > /dev/null || {
              echo "::error::Invalid docker-compose.yml in $dir"
              exit 1
            }
            cd - > /dev/null
            
            # Clean up
            rm -f "$dir/.env"
            
            echo "✓ $compose_file is valid"
          done
  
  validate-structure:
    name: Validate Stack Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check required files
        run: |
          exit_code=0
          for stack_dir in stacks/*/*; do
            if [ -d "$stack_dir" ]; then
              echo "Checking $stack_dir"
              
              # Check for required files
              if [ ! -f "$stack_dir/docker-compose.yml" ]; then
                echo "::error::Missing docker-compose.yml in $stack_dir"
                exit_code=1
              fi
              
              if [ ! -f "$stack_dir/.env.example" ]; then
                echo "::error::Missing .env.example in $stack_dir"
                exit_code=1
              fi
              
              if [ ! -f "$stack_dir/README.md" ]; then
                echo "::error::Missing README.md in $stack_dir"
                exit_code=1
              fi
              
              echo "✓ $stack_dir structure is valid"
            fi
          done
          exit $exit_code
  
  shellcheck:
    name: Shellcheck Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run shellcheck
        run: |
          # Find all shell scripts
          find . -name "*.sh" -type f -not -path "./.git/*" | while read -r script; do
            echo "Checking $script"
            shellcheck "$script" || echo "::warning::Shellcheck failed for $script"
          done
